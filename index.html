<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI ë°°í‹€ ë¡œì–„ (32ê°• ëŒ€ì§„í‘œ)</title>
    <style>
        body { background: #1a1a1a; color: white; font-family: 'Noto Sans KR', sans-serif; margin: 0; overflow-x: auto; }
        .header { text-align: center; padding: 20px; position: sticky; top: 0; background: #1a1a1a; z-index: 100; border-bottom: 1px solid #444; }
        
        /* ì…ë ¥ì°½ ë””ìì¸ */
        .input-group { display: inline-block; background: #333; padding: 10px; border-radius: 10px; }
        input, textarea { background: #222; border: 1px solid #555; color: white; padding: 8px; border-radius: 4px; margin: 2px; width: 150px;}
        textarea { width: 300px; height: 40px; vertical-align: middle; }
        button { background: gold; border: none; padding: 8px 15px; font-weight: bold; cursor: pointer; border-radius: 4px; }
        
        /* ëŒ€ì§„í‘œ ë ˆì´ì•„ì›ƒ (Flexbox) */
        .bracket-container { display: flex; padding: 40px; min-width: 1200px; justify-content: center; }
        .round-column { display: flex; flex-direction: column; justify-content: space-around; margin: 0 20px; position: relative; }
        .round-title { text-align: center; font-weight: bold; color: #aaa; margin-bottom: 20px; font-size: 1.2em; }
        
        /* ê²½ê¸° ë°•ìŠ¤ */
        .match-box { 
            width: 200px; background: #2a2a2a; border: 1px solid #444; border-radius: 8px; 
            padding: 10px; margin: 10px 0; position: relative; transition: 0.3s;
        }
        .match-box:hover { border-color: gold; transform: scale(1.05); z-index: 10; }
        .match-box::after { /* ì—°ê²°ì„  */
            content: ""; position: absolute; right: -22px; top: 50%; width: 20px; height: 2px; background: #555;
        }
        .round-column:last-child .match-box::after { display: none; } /* ê²°ìŠ¹ì „ì€ ì„  ì—†ìŒ */

        .player-row { display: flex; align-items: center; margin: 4px 0; font-size: 0.9em; }
        .p-img { width: 25px; height: 25px; border-radius: 50%; margin-right: 5px; border: 1px solid #555; }
        .winner-row { color: gold; font-weight: bold; text-shadow: 0 0 5px rgba(255,215,0,0.5); }
        .loser-row { color: #666; text-decoration: line-through; }
        
        /* ë¡œë”©/ê²°ê³¼ì°½ */
        #overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 200; align-items: center; justify-content: center; flex-direction: column; }
        #overlay-text { font-size: 2em; color: gold; margin-bottom: 20px; text-align: center; white-space: pre-wrap;}
        .big-img { width: 200px; height: 200px; border-radius: 50%; border: 5px solid gold; box-shadow: 0 0 30px gold; }
        .close-btn { margin-top: 30px; padding: 10px 30px; font-size: 1.2em; background: white; }
    </style>
</head>
<body>
    <div class="header">
        <h2>ğŸ† AI ë°°í‹€ ë¡œì–„ (32ê°• í† ë„ˆë¨¼íŠ¸)</h2>
        
        <div class="input-group" id="reg-box">
            <input type="text" id="name" placeholder="ë‹‰ë„¤ì„">
            <input type="text" id="skill" placeholder="í•„ì‚´ê¸° (ì§§ê²Œ)">
            <textarea id="detail" placeholder="ì„¤ì •/ì•½ì  (ê¸¸ê²Œ)"></textarea>
            <input type="file" id="imgInput" accept="image/*" style="width:180px;">
            <button onclick="register()">ë“±ë¡</button>
        </div>
        
        <div style="margin-top:10px;">
            <span id="status" style="color:#0f0; margin-right:20px;">ëŒ€ê¸°ì‹¤: 0ëª…</span>
            <button onclick="startTournament()" style="background:#ff4444; color:white;">ğŸ”¥ ëŒ€ì§„í‘œ ìƒì„± ë° ì‹œì‘ (32ëª… ìë™ ì±„ì›€)</button>
        </div>
    </div>

    <div class="bracket-container" id="bracket">
        <div style="color:#666; margin-top:50px;">ì°¸ê°€ìê°€ ë“±ë¡ë˜ë©´ ì—¬ê¸°ì— ëŒ€ì§„í‘œê°€ ë‚˜íƒ€ë‚©ë‹ˆë‹¤...</div>
    </div>

    <div id="overlay">
        <div id="overlay-text"></div>
        <div id="overlay-content"></div>
        <button class="close-btn" onclick="closeOverlay()">ë‹«ê¸°</button>
    </div>

    <script>
        // ğŸš¨ ì£¼ì†Œ ì…ë ¥ 
        const SERVER_URL = "https://2370d655-4aef-4419-aefc-53bb80ee4dd1-00-2rwi6mcfrqjc2.sisko.replit.dev";

        let selectedImageBase64 = "";
        document.getElementById('imgInput').addEventListener('change', function() {
            const reader = new FileReader();
            reader.onloadend = function() { selectedImageBase64 = reader.result; }
            if(this.files[0]) reader.readAsDataURL(this.files[0]);
        });

        // ë“±ë¡
        async function register() {
            const name = document.getElementById('name').value;
            const skill = document.getElementById('skill').value;
            const detail = document.getElementById('detail').value;
            let img = selectedImageBase64 || `https://api.dicebear.com/9.x/adventurer/svg?seed=${name}`;

            if(!name) return alert("ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!");

            try {
                await fetch(`${SERVER_URL}/register`, {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({name, skill, skill_detail: detail, weakness: detail, image: img})
                });
                alert("ë“±ë¡ ì™„ë£Œ!");
                document.getElementById('name').value = "";
                updateCount();
            } catch(e) { alert("ë“±ë¡ ì‹¤íŒ¨"); }
        }

        async function updateCount() {
            try {
                const res = await fetch(`${SERVER_URL}/participants`);
                const list = await res.json();
                document.getElementById('status').innerText = `ëŒ€ê¸°ì‹¤: ${list.length}ëª…`;
            } catch(e) {}
        }
        setInterval(updateCount, 2000);

        // í† ë„ˆë¨¼íŠ¸ ì‹œì‘ ë° ê·¸ë¦¬ê¸°
        async function startTournament() {
            const overlay = document.getElementById('overlay');
            const oText = document.getElementById('overlay-text');
            overlay.style.display = 'flex';
            oText.innerText = "â³ AIê°€ 32ëª…ì˜ ìš´ëª…ì„ ê³„ì‚° ì¤‘ì…ë‹ˆë‹¤...\n(ë¹ˆìë¦¬ëŠ” ë´‡ìœ¼ë¡œ ì±„ì›Œì§‘ë‹ˆë‹¤)";
            document.getElementById('overlay-content').innerHTML = "";

            try {
                const res = await fetch(`${SERVER_URL}/tournament`, { method: 'POST' });
                const data = await res.json();
                
                renderBracket(data.history); // ëŒ€ì§„í‘œ ê·¸ë¦¬ê¸° í•¨ìˆ˜ í˜¸ì¶œ
                
                // ìš°ìŠ¹ì ë°œí‘œ
                oText.innerText = `ğŸ‘‘ ìµœì¢… ìš°ìŠ¹: ${data.final_winner.name} ğŸ‘‘`;
                document.getElementById('overlay-content').innerHTML = `
                    <img src="${data.final_winner.image}" class="big-img">
                    <p style="color:white; font-size:1.2em;">${data.final_winner.skill}</p>
                `;

            } catch(e) {
                oText.innerText = "ì—ëŸ¬ ë°œìƒ! ì„œë²„ ìƒíƒœë¥¼ í™•ì¸í•˜ì„¸ìš”.";
            }
        }

        function closeOverlay() {
            document.getElementById('overlay').style.display = 'none';
        }

        // [í•µì‹¬] ëŒ€ì§„í‘œ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function renderBracket(history) {
            const container = document.getElementById('bracket');
            container.innerHTML = "";

            history.forEach((round, rIndex) => {
                const col = document.createElement('div');
                col.className = 'round-column';
                
                // ë¼ìš´ë“œ ì´ë¦„ (32ê°•, 16ê°•...)
                let roundName = "";
                if (rIndex === 0) roundName = "32ê°•";
                else if (rIndex === 1) roundName = "16ê°•";
                else if (rIndex === 2) roundName = "8ê°•";
                else if (rIndex === 3) roundName = "4ê°•";
                else if (rIndex === 4) roundName = "ê²°ìŠ¹";
                
                col.innerHTML = `<div class="round-title">${roundName}</div>`;

                round.matches.forEach(m => {
                    const box = document.createElement('div');
                    box.className = 'match-box';
                    
                    // p1, p2 ê·¸ë¦¬ê¸°
                    const p1Class = m.winner === m.p1.name ? "winner-row" : "loser-row";
                    const p2Class = m.winner === m.p2.name ? "winner-row" : "loser-row";
                    
                    box.innerHTML = `
                        <div class="player-row ${p1Class}" title="${m.log}">
                            <img src="${m.p1.image}" class="p-img">${m.p1.name}
                        </div>
                        <div class="player-row ${p2Class}" title="${m.log}">
                            <img src="${m.p2.image}" class="p-img">${m.p2.name}
                        </div>
                    `;
                    // í´ë¦­í•˜ë©´ ë¡œê·¸ ë³´ê¸°
                    box.onclick = () => alert(`[ì „íˆ¬ ë¡œê·¸]\n\n${m.log}\n\nğŸ‘‰ìŠ¹ë¦¬ìš”ì¸: ${m.reason}`);
                    col.appendChild(box);
                });

                container.appendChild(col);
            });
            
            // ìµœì¢… ìš°ìŠ¹ì ì»¬ëŸ¼ ì¶”ê°€
            const winnerCol = document.createElement('div');
            winnerCol.className = 'round-column';
            winnerCol.innerHTML = `<div class="round-title">ìš°ìŠ¹</div><div class="match-box" style="border-color:gold; color:gold; font-weight:bold; text-align:center;">ğŸ‘‘ CHAMP ğŸ‘‘</div>`;
            container.appendChild(winnerCol);
        }
    </script>
</body>
</html>
