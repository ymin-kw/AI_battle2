<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <title>AI Battle Royale - Main Stadium</title>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { background: #0b0b15; color: white; font-family: 'Noto Sans KR', sans-serif; margin: 0; overflow-x: hidden; }
        
        /* ğŸ”Š ì‚¬ìš´ë“œ ì»¨íŠ¸ë¡¤ */
        .sound-panel { position: fixed; bottom: 20px; right: 20px; z-index: 999; }
        .sound-btn { background: #333; border: 1px solid #555; color: white; padding: 10px; border-radius: 50%; cursor: pointer; width: 50px; height: 50px; font-size: 1.2em; }
        
        /* ğŸ“º ìƒë‹¨ ëŒ€ê¸°ì‹¤ (ë‰´ìŠ¤ í‹°ì»¤ ìŠ¤íƒ€ì¼) */
        .header { background: rgba(0,0,0,0.9); padding: 15px 30px; border-bottom: 2px solid #00f3ff; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; box-shadow: 0 0 20px rgba(0, 243, 255, 0.2); }
        .logo { font-size: 1.5em; font-weight: bold; font-style: italic; color: #00f3ff; text-shadow: 0 0 10px #00f3ff; }
        
        .marquee-container { flex-grow: 1; margin: 0 30px; background: #1a1a2e; border-radius: 5px; overflow: hidden; white-space: nowrap; padding: 10px; position: relative; }
        .marquee-content { display: inline-block; color: #fff; font-weight: bold; animation: marquee 20s linear infinite; }
        @keyframes marquee { 0% { transform: translateX(100%); } 100% { transform: translateX(-100%); } }
        
        .control-btn { padding: 10px 20px; font-weight: bold; border: none; cursor: pointer; border-radius: 5px; margin-left: 10px; font-size: 1em; transition: 0.2s; }
        .btn-start { background: gold; color: black; box-shadow: 0 0 15px gold; }
        .btn-reset { background: #ff4444; color: white; }
        .btn-start:hover { transform: scale(1.05); }

        /* ğŸ† ëŒ€ì§„í‘œ ì˜ì—­ */
        .bracket-container { display: flex; justify-content: center; padding: 50px 20px; min-width: 1400px; margin-top: 20px; }
        .round-col { display: flex; flex-direction: column; justify-content: space-around; margin: 0 15px; position: relative; }
        .round-title { text-align: center; color: #888; font-weight: bold; margin-bottom: 20px; letter-spacing: 2px; }
        
        .match-card { 
            width: 180px; background: #161623; border: 1px solid #333; border-radius: 8px; 
            padding: 5px; margin: 5px 0; cursor: pointer; position: relative; transition: 0.3s;
        }
        .match-card:hover { border-color: #00f3ff; box-shadow: 0 0 15px rgba(0,243,255,0.3); transform: scale(1.05); z-index: 10; }
        .match-card.active { border-color: #0f0; box-shadow: 0 0 10px #0f0; }
        
        /* ëŒ€ì§„í‘œ ì—°ê²°ì„  */
        .match-card::after { content: ""; position: absolute; right: -32px; top: 50%; width: 32px; height: 2px; background: #333; }
        .round-col:last-child .match-card::after { display: none; }

        .p-row { display: flex; align-items: center; padding: 4px; font-size: 0.85em; height: 28px; border-bottom: 1px solid #222; }
        .p-row:last-child { border-bottom: none; }
        .p-img { width: 24px; height: 24px; border-radius: 50%; margin-right: 8px; object-fit: cover; background: #000; }
        .winner { color: gold; font-weight: bold; text-shadow: 0 0 5px rgba(255,215,0,0.5); }
        .loser { color: #555; text-decoration: line-through; }

        /* ğŸ¥Š ë°°í‹€/í”„ë¡œí•„ ëª¨ë‹¬ (íŒì—…) */
        .modal-overlay { display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); z-index: 1000; backdrop-filter: blur(5px); align-items: center; justify-content: center; }
        .modal-content { background: #1a1a2e; width: 900px; border: 2px solid #00f3ff; border-radius: 20px; padding: 40px; position: relative; box-shadow: 0 0 50px rgba(0,243,255,0.2); }
        
        .battle-stage { display: flex; justify-content: space-between; align-items: center; margin-bottom: 30px; }
        .fighter-box { text-align: center; width: 30%; position: relative; }
        .fighter-img { width: 180px; height: 180px; border-radius: 15px; border: 4px solid #555; object-fit: cover; transition: 0.5s; }
        .fighter-name { font-size: 1.5em; font-weight: bold; margin-top: 10px; color: white; }
        
        .vs-badge { font-size: 4em; font-style: italic; font-weight: bold; color: #ff4444; text-shadow: 0 0 20px red; }
        
        /* ìŠ¤íƒ¯ ì°¨íŠ¸ */
        .chart-container { width: 100%; height: 200px; margin-top: 10px; }
        
        .log-box { background: #000; color: #0f0; padding: 20px; border-radius: 10px; font-family: monospace; font-size: 1.1em; line-height: 1.6; min-height: 80px; border: 1px solid #333; text-align: left; white-space: pre-wrap; }
        
        .close-btn { position: absolute; top: 20px; right: 20px; background: none; border: none; color: #aaa; font-size: 2em; cursor: pointer; }
        
        /* ì• ë‹ˆë©”ì´ì…˜ íš¨ê³¼ */
        .winner-fx { border-color: gold; box-shadow: 0 0 50px gold; transform: scale(1.1); z-index: 10; }
        .loser-fx { filter: grayscale(100%) brightness(0.2); transform: scale(0.9); }
        @keyframes shake { 0% { transform: translate(1px, 1px); } 100% { transform: translate(-1px, -2px); } }
        .shake-fx { animation: shake 0.5s infinite; }

        /* ìƒì„¸ì •ë³´ ë³´ê¸° (Scouting) */
        .info-detail { font-size: 0.9em; color: #aaa; margin-top: 10px; text-align: left; background: #222; padding: 10px; border-radius: 5px;}
    </style>
</head>
<body>

    <div class="header">
        <div class="logo">ğŸ† AI Battle Arena</div>
        
        <div class="marquee-container">
            <div id="marquee-text" class="marquee-content">ëŒ€ê¸° ì¤‘... í•™ìƒë“¤ì˜ ì ‘ì†ì„ ê¸°ë‹¤ë¦¬ê³  ìˆìŠµë‹ˆë‹¤...</div>
        </div>
        
        <div style="display:flex; align-items:center;">
            <span id="counter" style="font-weight:bold; color:gold; margin-right:20px;">Ready: 0</span>
            <button onclick="initTournament()" class="control-btn btn-start">ğŸ”¥ ëŒ€íšŒ ì‹œì‘</button>
            <button onclick="resetServer()" class="control-btn btn-reset">ğŸ—‘ï¸ ë¦¬ì…‹</button>
        </div>
    </div>

    <div id="bracket-area" class="bracket-container">
        <div style="margin-top:100px; color:#555; font-size:1.5em;">
            ìƒë‹¨ 'ëŒ€íšŒ ì‹œì‘' ë²„íŠ¼ì„ ëˆ„ë¥´ë©´ ëŒ€ì§„í‘œê°€ ìƒì„±ë©ë‹ˆë‹¤.
        </div>
    </div>

    <div class="sound-panel">
        <button class="sound-btn" onclick="toggleSound()" id="soundBtn">ğŸ”‡</button>
    </div>

    <div id="battle-modal" class="modal-overlay">
        <div class="modal-content">
            <button class="close-btn" onclick="closeModal()">Ã—</button>
            <h2 id="modal-title" style="text-align:center; color:gold; margin-top:0;">MATCH START</h2>
            
            <div class="battle-stage">
                <div class="fighter-box">
                    <img id="p1-img" class="fighter-img" src="">
                    <div id="p1-name" class="fighter-name">Player 1</div>
                    <div class="chart-container"><canvas id="chart1"></canvas></div>
                    <div id="p1-info" class="info-detail" style="display:none;"></div>
                </div>
                
                <div class="vs-badge">VS</div>
                
                <div class="fighter-box">
                    <img id="p2-img" class="fighter-img" src="">
                    <div id="p2-name" class="fighter-name">Player 2</div>
                    <div class="chart-container"><canvas id="chart2"></canvas></div>
                    <div id="p2-info" class="info-detail" style="display:none;"></div>
                </div>
            </div>

            <div id="battle-log" class="log-box">
                AI ì‹¬íŒì´ ë‘ ì„ ìˆ˜ì˜ ë°ì´í„°ë¥¼ ë¶„ì„í•˜ê³  ìˆìŠµë‹ˆë‹¤...
            </div>
        </div>
    </div>

    <script>
        // ğŸš¨ [í•„ìˆ˜] Replit ì£¼ì†Œ ì…ë ¥ (ë§¨ ë’¤ ìŠ¬ë˜ì‹œ ì œì™¸)
        const SERVER_URL = "https://2370d655-4aef-4419-aefc-53bb80ee4dd1-00-2rwi6mcfrqjc2.sisko.replit.dev";

        // --- ì‚¬ìš´ë“œ ì‹œìŠ¤í…œ ---
        const audio = {
            bgm: new Audio('https://opengameart.org/sites/default/files/heroic_demise_0.mp3'), // ë¬´ë£Œ BGM ì˜ˆì‹œ
            hit: new Audio('https://opengameart.org/sites/default/files/punch.mp3'),
            win: new Audio('https://opengameart.org/sites/default/files/mission_complete.mp3')
        };
        let isSoundOn = false;
        audio.bgm.loop = true;
        audio.bgm.volume = 0.3;

        function toggleSound() {
            isSoundOn = !isSoundOn;
            const btn = document.getElementById('soundBtn');
            if(isSoundOn) {
                btn.innerText = "ğŸ”Š";
                audio.bgm.play().catch(e=>console.log("ì¬ìƒë¶ˆê°€"));
            } else {
                btn.innerText = "ğŸ”‡";
                audio.bgm.pause();
            }
        }

        function playSfx(type) {
            if(!isSoundOn) return;
            if(type === 'hit') audio.hit.play();
            if(type === 'win') audio.win.play();
        }

        // --- ëŒ€ê¸°ì‹¤ ë¡œì§ ---
        async function updateWaitingRoom() {
            try {
                const res = await fetch(`${SERVER_URL}/participants`);
                const list = await res.json();
                
                document.getElementById('counter').innerText = `Ready: ${list.length}`;
                
                // ë‰´ìŠ¤ í‹°ì»¤ ì—…ë°ì´íŠ¸
                const names = list.map(p => `[${p.name}]`).join(" ");
                const ticker = document.getElementById('marquee-text');
                ticker.innerText = names ? `í˜„ì¬ ì ‘ì†ì: ${names}` : "ëŒ€ê¸° ì¤‘... í•™ìƒë“¤ì€ ì ‘ì†í•´ì£¼ì„¸ìš”.";
            } catch(e) {}
        }
        setInterval(updateWaitingRoom, 2000);

        async function resetServer() {
            if(!confirm("ì •ë§ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            await fetch(`${SERVER_URL}/reset`);
            location.reload();
        }

        // --- í† ë„ˆë¨¼íŠ¸ ë¡œì§ ---
        async function initTournament() {
            if(!confirm("32ê°• ëŒ€ì§„í‘œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.")) return;
            const res = await fetch(`${SERVER_URL}/init_tournament`, {method:'POST'});
            const data = await res.json();
            renderBracket(data);
        }

        // ì°¨íŠ¸ ê°ì²´ ì €ì¥ìš©
        let chart1 = null;
        let chart2 = null;

        // ê²½ê¸° ì‹¤í–‰ (íŒì—… ì—´ê¸°)
        async function playMatch(rIdx, mIdx, p1, p2) {
            const modal = document.getElementById('battle-modal');
            modal.style.display = 'flex';
            
            // ì´ˆê¸°í™”
            document.getElementById('modal-title').innerText = "âš”ï¸ BATTLE START âš”ï¸";
            document.getElementById('battle-log').innerText = "AI ì‹¬íŒì´ ë°ì´í„°ë¥¼ ë¶„ì„ ì¤‘ì…ë‹ˆë‹¤...";
            
            // ì´ë¯¸ì§€ & í…ìŠ¤íŠ¸ ì„¸íŒ…
            const img1 = document.getElementById('p1-img');
            const img2 = document.getElementById('p2-img');
            img1.src = p1.image; img2.src = p2.image;
            img1.className = "fighter-img shake-fx"; img2.className = "fighter-img shake-fx"; // í”ë“¤ë¦¼ íš¨ê³¼
            
            document.getElementById('p1-name').innerText = p1.name;
            document.getElementById('p2-name').innerText = p2.name;

            // ìƒì„¸ ì •ë³´ í‘œì‹œ (Scouting Report)
            document.getElementById('p1-info').style.display = 'block';
            document.getElementById('p2-info').style.display = 'block';
            document.getElementById('p1-info').innerHTML = `<b>ê¸°ìˆ :</b> ${p1.skill}<br><b>ì„¤ëª…:</b> ${p1.skill_detail}<br><b style='color:red'>ì•½ì :</b> ${p1.weakness}`;
            document.getElementById('p2-info').innerHTML = `<b>ê¸°ìˆ :</b> ${p2.skill}<br><b>ì„¤ëª…:</b> ${p2.skill_detail}<br><b style='color:red'>ì•½ì :</b> ${p2.weakness}`;

            // ì°¨íŠ¸ ê·¸ë¦¬ê¸°
            drawStatChart('chart1', p1.stats, '#00f3ff');
            drawStatChart('chart2', p2.stats, '#ff4444');

            playSfx('hit'); // ì‹œì‘ ì†Œë¦¬

            // ì„œë²„ ìš”ì²­
            try {
                const res = await fetch(`${SERVER_URL}/play_match`, {
                    method: 'POST', headers: {'Content-Type':'application/json'},
                    body: JSON.stringify({r_idx: rIdx, m_idx: mIdx})
                });
                const data = await res.json();
                
                // ê²°ê³¼ ì—°ì¶œ (2ì´ˆ ë”œë ˆì´)
                setTimeout(() => {
                    const match = data.match;
                    img1.classList.remove('shake-fx'); img2.classList.remove('shake-fx');
                    
                    document.getElementById('battle-log').innerHTML = `${match.log}\n\n<b style="color:orange">ğŸ‘‰ ìŠ¹ë¦¬ ìš”ì¸: ${match.reason}</b>`;
                    document.getElementById('modal-title').innerText = `ğŸ† ${match.winner.name} WIN!`;
                    
                    if (match.winner.name === p1.name) {
                        img1.classList.add('winner-fx'); img2.classList.add('loser-fx');
                    } else {
                        img2.classList.add('winner-fx'); img1.classList.add('loser-fx');
                    }
                    playSfx('win'); // ìŠ¹ë¦¬ ì†Œë¦¬
                    
                    // ë°±ê·¸ë¼ìš´ë“œ ê°±ì‹ 
                    fetch(`${SERVER_URL}/state`).then(r=>r.json()).then(d=>renderBracket(d));

                }, 2000);

            } catch(e) { alert("ì˜¤ë¥˜"); closeModal(); }
        }

        function closeModal() {
            document.getElementById('battle-modal').style.display = 'none';
        }

        // ì°¨íŠ¸ ê·¸ë¦¬ê¸° í•¨ìˆ˜
        function drawStatChart(canvasId, stats, color) {
            const ctx = document.getElementById(canvasId).getContext('2d');
            // ê¸°ì¡´ ì°¨íŠ¸ íŒŒê´´ (ì¤‘ë³µ ë°©ì§€)
            if(canvasId === 'chart1' && chart1) chart1.destroy();
            if(canvasId === 'chart2' && chart2) chart2.destroy();

            const config = {
                type: 'radar',
                data: {
                    labels: ['PWR', 'DEF', 'SPD', 'INT', 'VAR'],
                    datasets: [{
                        label: 'Stats',
                        data: [stats.PWR, stats.DEF, stats.SPD, stats.INT, stats.VAR],
                        backgroundColor: color + '33', // íˆ¬ëª…ë„
                        borderColor: color,
                        borderWidth: 2,
                        pointBackgroundColor: '#fff'
                    }]
                },
                options: {
                    scales: { r: { min: 0, max: 100, ticks: {display:false}, grid: {color:'#444'}, pointLabels: {color:'#aaa', font:{size:10}} } },
                    plugins: { legend: {display:false} },
                    animation: { duration: 1000 }
                }
            };

            if(canvasId === 'chart1') chart1 = new Chart(ctx, config);
            else chart2 = new Chart(ctx, config);
        }

        // ëŒ€ì§„í‘œ ë Œë”ë§
        function renderBracket(state) {
            const area = document.getElementById('bracket-area');
            area.innerHTML = "";
            if(!state.rounds) return;

            state.rounds.forEach((round, rIdx) => {
                const col = document.createElement('div');
                col.className = 'round-col';
                
                const title = document.createElement('div');
                title.className = 'round-title';
                title.innerText = rIdx === 4 ? "WINNER" : `R${rIdx+1}`;
                col.appendChild(title);

                round.forEach((match, mIdx) => {
                    const box = document.createElement('div');
                    box.className = `match-card ${(!match.winner && match.p1 && match.p2) ? 'active' : ''}`;
                    
                    // í´ë¦­ ì´ë²¤íŠ¸
                    if (!match.winner && match.p1 && match.p2) {
                        box.onclick = () => playMatch(rIdx, mIdx, match.p1, match.p2);
                    } else if (match.winner) {
                        box.style.opacity = "0.5"; // ëë‚œ ê²½ê¸° íë¦¬ê²Œ
                    }

                    const drawP = (p, isWinner) => {
                        if (!p) return `<div class="p-row">?</div>`;
                        const cls = isWinner ? "winner" : (match.winner ? "loser" : "");
                        return `<div class="p-row ${cls}">
                                    <img src="${p.image}" class="p-img"> ${p.name}
                                </div>`;
                    };

                    const isP1 = match.winner && match.winner.name === match.p1.name;
                    const isP2 = match.winner && match.p2 && match.winner.name === match.p2.name;

                    box.innerHTML = drawP(match.p1, isP1) + drawP(match.p2, isP2);
                    col.appendChild(box);
                });
                area.appendChild(col);
            });
        }
    </script>
</body>
</html>
